#!/usr/bin/env bash

# Strict mode
set -euo pipefail

cd /openedx/edx-platform

USAGE="usage: bash $0 [-s|--skip-assets]"
scriptname="$(basename "$0")"

# Should we compile static assets? Default is yes.
skip_assets=''
set +u
if [ -n "$2" ] ; then
	echo "$USAGE"
	exit 1
elif [ -n "$1" ] ; then
	if [ "$1" = "-s" ] || [ "$1" = "--skip-assets" ]; then
		skip_assets='1'
	else
		echo "$USAGE"
		exit 1
	fi
fi
set -u

if [ -n "$(ls /openedx/mounted-packages)" ] ; then
	echo "$scriptname: installing packages at /openedx/mounted-packages"
	set -x
	for PACKAGE in /openedx/mounted-packages/* ; do
		pip install -e "$PACKAGE"
	done
	set +x
else
	echo "$scriptname: no mounted packages at /openedx/mounted-packages to install"
fi

echo "$scriptname: running edx-platform's setup.py"
set -x
pip install -e .
set +x

if [ -L node_modules ] ; then
	echo "$scriptname: node_modules is already a symbolic link"
else
	if [ -d node_modules ] ; then
		echo "$scriptname: saving old edx-platform/node_modules to edx-platform/node_modules.bak"
		set -x
		mv node_modules node_modules.bak
		set +x
	fi
	echo "$scriptname: linking edx-platform/node_modules -> /openedx/node_modules"
	set -x
	ln -s /openedx/node_modules node_modules
	set +x
fi

if [ -n "$skip_assets" ] ; then
	echo "$scriptname: skipping static assets build"
else
	echo "$scriptname: building static assets into edx-platform for development"
	set -x
	openedx-assets build --env=dev
	set +x
fi

